import maya.cmds as cmds

def create_global_scale_attr(control_name):
    """Creates a global scale attribute on the given control, connects it to scale, and locks & hides the scale attributes."""
    attr_name = "globalScale"
    
    if not cmds.objExists(control_name):
        cmds.warning(f"Control '{control_name}' does not exist.")
        return
    
    # Add globalScale attribute if it doesn’t exist
    if not cmds.attributeQuery(attr_name, node=control_name, exists=True):
        cmds.addAttr(control_name, ln=attr_name, at="double", dv=1.0, min=1.0, keyable=True)
    
    # Connect globalScale to the control’s scale attributes
    for axis in ["X", "Y", "Z"]:
        cmds.connectAttr(f"{control_name}.{attr_name}", f"{control_name}.scale{axis}", force=True)
        cmds.setAttr(f"{control_name}.scale{axis}", lock=True, keyable=False, channelBox=False)  # Lock & hide scale

def apply_scale_constraint(control_name, skeleton_group):
    """Applies a scale constraint from the control to the skeleton main group."""
    if not cmds.objExists(control_name) or not cmds.objExists(skeleton_group):
        cmds.warning("Invalid control or skeleton group selected.")
        return
    
    # Remove existing constraints to avoid duplicates
    existing_constraints = cmds.listRelatives(skeleton_group, type="scaleConstraint") or []
    cmds.delete(existing_constraints)

    # Apply a scale constraint
    cmds.scaleConstraint(control_name, skeleton_group, maintainOffset=True)

def disable_segment_scale():
    """Turns off segment scale compensate for all joints in the scene."""
    joints = cmds.ls(type="joint")
    for joint in joints:
        if cmds.objExists(f"{joint}.segmentScaleCompensate"):
            cmds.setAttr(f"{joint}.segmentScaleCompensate", 0)

def setup_global_scale(control_name, skeleton_group):
    """Runs the full setup process for global scaling."""
    create_global_scale_attr(control_name)
    apply_scale_constraint(control_name, skeleton_group)
    disable_segment_scale()
    
    cmds.confirmDialog(title="Success", message="Global Scale setup applied successfully!", button=["OK"])

def open_scale_setup_ui():
    """Opens a UI to set up global scaling."""
    if cmds.window("scaleSetupUI", exists=True):
        cmds.deleteUI("scaleSetupUI")

    window = cmds.window("scaleSetupUI", title="Global Scale Setup", widthHeight=(300, 150))
    cmds.columnLayout(adjustableColumn=True)

    cmds.text(label="Select the Control for Global Scale:")
    control_field = cmds.textFieldButtonGrp("controlField", buttonLabel="Pick Control", 
                                            bc=lambda: cmds.textFieldButtonGrp("controlField", edit=True, 
                                            text=cmds.ls(selection=True)[0] if cmds.ls(selection=True) else ""))

    cmds.text(label="Select the Skeleton Main Group:")
    skel_field = cmds.textFieldButtonGrp("skeletonField", buttonLabel="Pick Group", 
                                         bc=lambda: cmds.textFieldButtonGrp("skeletonField", edit=True, 
                                         text=cmds.ls(selection=True)[0] if cmds.ls(selection=True) else ""))

    cmds.button(label="Apply Global Scale", command=lambda _: setup_global_scale(
        cmds.textFieldButtonGrp("controlField", query=True, text=True),
        cmds.textFieldButtonGrp("skeletonField", query=True, text=True)
    ))

    cmds.showWindow(window)

# Open UI
open_scale_setup_ui()
